default:
    image: node:18.20.4-alpine
    before_script:
        - npm ci --cache .npm --prefer-offline
        - |
            {
              echo "@${CI_PROJECT_ROOT_NAMESPACE}:registry=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/"
              echo "${CI_API_V4_URL#https?}/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=\${CI_JOB_TOKEN}"
            } | tee -a .npmrc
    cache:
        key: ${CI_COMMIT_REF_SLUG}
        paths:
            - .npm/

workflow:
    rules:
        - if: $CI_COMMIT_BRANCH

variables:
    NPM_TOKEN: ${CI_JOB_TOKEN}

stages:
    - release

publish:
    stage: release
    tags:
        - docker # shared gitlab runner tag
    script:
        - apk update && apk add git
        - git fetch --tags --force
        - npm set registry ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/
        - npm run build
        - npm run semantic-release
    rules:
        - if: $CI_COMMIT_BRANCH == 'master'
